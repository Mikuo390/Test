<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ZXing 條碼掃描</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 5px;
        }
        video {
            border: 1px solid #ccc;
            margin-bottom: 5px;
            position: relative;
        }
        /* 掃描框樣式，初始隱藏 */
        #scan-frame {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 50%;
            height: 50%;
            border: 2px solid red;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.5);
            pointer-events: none;
            display: none;
        }
        /* 掃碼線樣式，初始隱藏 */
        #scan-line {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background-color: lime;
            animation: scan-line-animation 2s infinite;
            display: none;
        }
        /* 掃碼線的上下移動動畫 */
        @keyframes scan-line-animation {
            0% {
                top: 0;
            }
            100% {
                top: 100%;
            }
        }
    </style>
    <!-- 正確引入 @zxing/library 的 UMD 版本 -->
    <script src="https://cdn.jsdelivr.net/npm/@zxing/library@latest/umd/index.min.js"></script>
    <script src="https://unpkg.com/@zxing/library@0.21.3/umd/index.min.js"></script>
</head>
<body>
    <h1>ZXing 條碼掃描</h1>

    <!-- 攝像頭選擇區域 -->
    <div style="margin-bottom: 5px">
        <label for="camera-select">選擇攝像頭：</label>
        <select id="camera-select"></select>
    </div>

    <!-- 攝像頭視頻流區域 -->
    <div style="position: relative; margin-bottom: 5px">
        <video id="video" width="100%" height="80%" autoplay></video>
        <!-- 掃描框 -->
        <div id="scan-frame">
            <!-- 掃碼線 -->
            <div id="scan-line"></div>
        </div>
    </div>

    <!-- 用於顯示縮放支援狀態 -->
    <div id="zoom-support" style="margin-top: 5px; color: blue">
        縮放支援狀態：未知
    </div>

    <!-- 缩放控制區域 -->
    <div style="margin-top: 5px">
        <label for="zoom-control">縮放：</label>
        <input type="range" id="zoom-control" min="1" max="3" step="0.1" />
    </div>

    <!-- 顯示掃描結果的區域 -->
    <div id="result" style="margin-top: 5px">
        條碼結果：<span id="barcode-result"></span>
    </div>

    <!-- 用於顯示掃描狀態 -->
    <div id="scan-status" style="margin-top: 5px; color: green">
        掃描狀態：未開始
    </div>

    <!-- 用於顯示錯誤消息 -->
    <div id="error-message" style="margin-top: 5px; color: red">
        錯誤消息：無
    </div>

    <script>
        // 初始化 ZXing 條碼讀取器
        const codeReader = new ZXing.BrowserMultiFormatReader();
        let lastResult = ""; 
        let selectedDeviceId = null;
        let stream = null;

        // 更新掃描狀態的函數
        function updateScanStatus(status) {
            document.getElementById("scan-status").textContent = `掃描狀態：${status}`;
        }

        // 檢查攝像頭權限並開始掃描
        async function startScanning() {
            // if (!selectedDeviceId) return;
            console.log("Start Scan");

            updateScanStatus("正在掃描中，請稍候");

            // 停止之前的視頻流
            if (stream) {
                stream.getTracks().forEach((track) => track.stop());
            }

            // 顯示掃描框和掃碼線
            document.getElementById("scan-frame").style.display = "block";
            document.getElementById("scan-line").style.display = "block";

            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { deviceId: selectedDeviceId },
                });
                document.getElementById("video").srcObject = stream;

                codeReader.decodeFromVideoDevice(
                    selectedDeviceId,
                    "video",
                    (result, err) => {
                        if (result) {
                            updateScanStatus("掃描成功");
                            document.getElementById("barcode-result").textContent = result.text;
                            document.getElementById("scan-frame").style.display = "none";
                            document.getElementById("scan-line").style.display = "none";
                            lastResult = result.text;
                        } else {
                            document.getElementById("scan-frame").style.display = "block";
                            document.getElementById("scan-line").style.display = "block";
                        }

                        if (err && !(err instanceof ZXing.NotFoundException)) {
                            console.error("掃描錯誤:", err);
                            document.getElementById("error-message").textContent = `錯誤消息：${err.message}`;
                        }
                    }
                );
            } catch (err) {
                console.error("無法獲取攝像頭視頻流:", err);
                updateScanStatus("無法開始掃描");
            }
        }

        startScanning();
    </script>
</body>
</html>
