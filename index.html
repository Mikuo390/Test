<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ZXing 條碼掃描</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 20px;
        }
        video {
            border: 1px solid #ccc;
            margin-bottom: 20px;
            position: relative;
        }
        /* 掃描框樣式，初始隱藏 */
        #scan-frame {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 50%;
            height: 50%;
            border: 2px solid red;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.5);
            pointer-events: none;
            display: none;
        }
        /* 掃碼線樣式，初始隱藏 */
        #scan-line {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background-color: lime;
            animation: scan-line-animation 2s infinite;
            display: none;
        }
        /* 掃碼線的上下移動動畫 */
        @keyframes scan-line-animation {
            0% {
                top: 0;
            }
            100% {
                top: 100%;
            }
        }
    </style>
    <!-- 正確引入 @zxing/library 的 UMD 版本 -->
    <script src="https://cdn.jsdelivr.net/npm/@zxing/library@latest/umd/index.min.js"></script>
    <script src="https://unpkg.com/@zxing/library@0.21.3/umd/index.min.js"></script>
</head>
<body>
    <h3>ZXing 條碼掃描</h1>

    <!-- 攝像頭選擇區域 -->
    <div style="margin-bottom: 20px">
        <label for="camera-select">選擇攝像頭：</label>
        <select id="camera-select"></select>
    </div>

    <!-- 攝像頭視頻流區域 -->
    <div style="position: relative">
        <video id="video" width="100%" height="80%" autoplay></video>
        <!-- 掃描框 -->
        <div id="scan-frame">
            <!-- 掃碼線 -->
            <div id="scan-line"></div>
        </div>
    </div>

    <!-- div 用於顯示縮放支援狀態 -->
    <div id="zoom-support" style="margin-top: 20px; color: blue">
        縮放支援狀態：未知
    </div>

    <!-- 缩放控制區域 -->
    <div style="margin-top: 20px">
        <label for="zoom-control">縮放：</label>
        <input type="range" id="zoom-control" min="1" max="3" step="0.1" />
    </div>

    <!-- 顯示掃描結果的區域 -->
    <div id="result" style="margin-top: 20px">
        條碼結果：<span id="barcode-result"></span>
    </div>

    <!-- div 用於顯示掃描狀態 -->
    <div id="scan-status" style="margin-top: 20px; color: green">
        掃描狀態：未開始
    </div>

    <!-- div 用於顯示錯誤消息 -->
    <div id="error-message" style="margin-top: 20px; color: red">
        錯誤消息：無
    </div>

    <script>
        // 初始化 ZXing 條碼讀取器
        const codeReader = new ZXing.BrowserMultiFormatReader();
        let lastResult = ""; // 用於保存上一次掃描結果
        let selectedDeviceId = null; // 用於保存用戶選擇的攝像頭設備ID
        let stream = null; // 用於保存視頻流

        // 顯示錯誤消息
        function displayErrorMessage(message) {
            document.getElementById("error-message").textContent = "錯誤消息：" + message;
        }

        // 獲取攝像頭設備並填充到下拉菜單
        async function getCamerasAndPopulateSelect() {
            try {
                const videoInputDevices = await codeReader.getVideoInputDevices();
                const cameraSelect = document.getElementById("camera-select");
                if (videoInputDevices.length > 0) {
                    selectedDeviceId = videoInputDevices[0].deviceId;
                    cameraSelect.innerHTML = "";

                    videoInputDevices.forEach((device, index) => {
                        const option = document.createElement("option");
                        option.value = device.deviceId;
                        option.text = device.label || `Camera ${index + 1}`;
                        cameraSelect.appendChild(option);
                    });
                    cameraSelect.value = selectedDeviceId;

                    cameraSelect.addEventListener("change", (event) => {
                        selectedDeviceId = event.target.value;
                        startScanning();
                    });
                    startScanning();
                } else {
                    console.error("沒有找到攝像頭設備");
                    displayErrorMessage("沒有找到攝像頭設備");
                }
            } catch (err) {
                console.error("無法獲取攝像頭設備:", err);
                displayErrorMessage("無法獲取攝像頭設備: " + err.message);
            }
        }

        async function startScanning() {
            if (!selectedDeviceId) return;
            document.getElementById("scan-status").textContent = "掃描狀態：正在掃描";

            if (stream) {
                stream.getTracks().forEach((track) => track.stop());
            }

            document.getElementById("scan-frame").style.display = "block";
            document.getElementById("scan-line").style.display = "block";

            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { deviceId: selectedDeviceId },
                });
                document.getElementById("video").srcObject = stream;

                const videoTrack = stream.getVideoTracks()[0];
                const capabilities = videoTrack.getCapabilities();

                if (capabilities.zoom) {
                    document.getElementById("zoom-support").textContent = "縮放支援狀態：支援";
                    const zoomControl = document.getElementById("zoom-control");
                    zoomControl.min = capabilities.zoom.min;
                    zoomControl.max = capabilities.zoom.max;
                    zoomControl.step = capabilities.zoom.step;
                    zoomControl.value = capabilities.zoom.min;

                    zoomControl.oninput = async (event) => {
                        const zoomLevel = event.target.value;
                        try {
                            await videoTrack.applyConstraints({
                                advanced: [{ zoom: zoomLevel }],
                            });
                        } catch (err) {
                            console.warn("無法設置縮放級別:", err);
                            displayErrorMessage("無法設置縮放級別: " + err.message);
                        }
                    };
                } else {
                    document.getElementById("zoom-support").textContent = "縮放支援狀態：不支援";
                }

                codeReader.decodeFromVideoDevice(
                    selectedDeviceId,
                    "video",
                    (result, err) => {
                        if (result) {
                            document.getElementById("scan-status").textContent = "掃描狀態：成功";
                            const currentResult = result.text;
                            document.getElementById("barcode-result").textContent = currentResult;

                            document.getElementById("scan-frame").style.display = "none";
                            document.getElementById("scan-line").style.display = "none";

                            lastResult = currentResult;
                        } else {
                            document.getElementById("scan-frame").style.display = "block";
                            document.getElementById("scan-line").style.display = "block";
                        }

                        if (err && !(err instanceof ZXing.NotFoundException)) {
                            console.error(err);
                            displayErrorMessage("掃描錯誤: " + err.message);
                        }
                    }
                );
            } catch (err) {
                console.error("無法獲取攝像頭視頻流:", err);
                displayErrorMessage("無法獲取攝像頭視頻流: " + err.message);
                document.getElementById("scan-status").textContent = "掃描狀態：失敗";
                document.getElementById("zoom-support").textContent = "縮放支援狀態：未知";
            }
        }

        getCamerasAndPopulateSelect();
    </script>
</body>
</html>
