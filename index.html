<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ZXing 條碼掃描</title>
    <style>
      body {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin: 20px;
      }
      video {
        border: 1px solid #ccc;
        margin-bottom: 20px;
        position: relative;
      }
      /* 掃描框樣式，初始隱藏 */
      #scan-frame {
        position: absolute;
        top: 50%; /* 掃描框垂直置中 */
        left: 50%; /* 掃描框水平置中 */
        width: 50%;
        height: 50%;
        border: 2px solid red;
        transform: translate(-50%, -50%);
        box-shadow: 0 0 15px rgba(255, 0, 0, 0.5);
        pointer-events: none; /* 不影響視頻點擊 */
        display: none; /* 默認隱藏 */
      }
      /* 掃碼線樣式，初始隱藏 */
      #scan-line {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 2px;
        background-color: lime;
        animation: scan-line-animation 2s infinite;
        display: none; /* 默認隱藏 */
      }
      /* 掃碼線的上下移動動畫 */
      @keyframes scan-line-animation {
        0% {
          top: 0;
        }
        100% {
          top: 100%;
        }
      }
    </style>
     <!-- 正確引入 @zxing/library 的 UMD 版本 -->
     <script src="https://cdn.jsdelivr.net/npm/@zxing/library@latest/umd/index.min.js"></script>

  </head>
  <body>
    <h1>ZXing 條碼掃描</h1>

    <!-- 攝像頭選擇區域 -->
    <div style="margin-bottom: 20px">
      <label for="camera-select">選擇攝像頭：</label>
      <select id="camera-select"></select>
    </div>

    <!-- 攝像頭視頻流區域 -->
    <div style="position: relative;">
      <video id="video" width="auto" height="auto" autoplay></video>
      <!-- 掃描框 -->
      <div id="scan-frame">
        <!-- 掃碼線 -->
        <div id="scan-line"></div>
      </div>
    </div>

    <!-- 顯示掃描結果的區域 -->
    <div id="result" style="margin-top: 20px">
      條碼結果：<span id="barcode-result"></span>
    </div>

    <script>
      // 初始化 ZXing 條碼讀取器
      const codeReader = new ZXing.BrowserMultiFormatReader();
      let lastResult = ""; // 用於保存上一次掃描結果
      let selectedDeviceId = null; // 用於保存用戶選擇的攝像頭設備ID

      // 獲取攝像頭設備並填充到下拉菜單
      async function getCamerasAndPopulateSelect() {
        try {
          // 獲取可用的攝像頭設備
          const videoInputDevices = await codeReader.getVideoInputDevices();
          const cameraSelect = document.getElementById("camera-select");
          if (videoInputDevices.length > 0) {
            // 默認選擇第一個設備
            selectedDeviceId = videoInputDevices[0].deviceId;
            console.log(videoInputDevices);

            // 清空下拉菜單
            cameraSelect.innerHTML = "";

            // 將每個攝像頭設備添加到下拉菜單中
            videoInputDevices.forEach((device, index) => {
              const option = document.createElement("option");
              option.value = device.deviceId;
              option.text = device.label || `Camera ${index + 1}`;
              cameraSelect.appendChild(option);
            });
            cameraSelect.value = selectedDeviceId;

            // 當用戶選擇不同的攝像頭時更新選擇的設備ID
            cameraSelect.addEventListener("change", (event) => {
              selectedDeviceId = event.target.value;
              startScanning(); // 重新開始掃描
            });

            // 啟動掃描
            startScanning();
          } else {
            console.error("沒有找到攝像頭設備");
          }

          // this.codeReader.listVideoInputDevices().then(res => {
          //     if (res.length) {
          //         this.videoInputDevice = res
          //         this.deviceId = res[1].deviceId
          //     }
          //     this.scanCode();
          // }).catch((err) => {
          //     uni.showModal({
          //         title: '提示',
          //         content: '当前浏览器环境不支持获取视频通道',
          //         showCancel: false
          //     });
          // })

        //   startScanning();
        } catch (err) {
          console.error("無法獲取攝像頭設備:", err);
        }
      }

      // 檢查攝像頭權限並開始掃描
      async function startScanning() {
        console.log("Start Scan")
        // if (!selectedDeviceId) return;

        // 顯示掃描框和掃碼線
        document.getElementById("scan-frame").style.display = "block";
        document.getElementById("scan-line").style.display = "block";

        // 開始從攝像頭捕獲視頻
        codeReader.decodeFromVideoDevice(
          selectedDeviceId,
          "video",
          (result, err) => {
            if (result) {
              // 獲取掃描結果
              const currentResult = result.text;

              // 顯示解碼後的結果
              document.getElementById("barcode-result").textContent =
                currentResult;

              // 無論是否相同，只要掃描成功都隱藏掃碼線和掃描框
              document.getElementById("scan-frame").style.display = "none";
              document.getElementById("scan-line").style.display = "none";

              // 更新最後一次的結果
              lastResult = currentResult;
            } else {
              // 如果沒有結果，繼續顯示掃碼線
              document.getElementById("scan-line").style.display = "block";
            }

            // 如果有錯誤但不是未找到條形碼的錯誤，記錄錯誤
            if (err && !(err instanceof ZXing.NotFoundException)) {
              console.error(err);
            }
          }
        );
      }

      // 獲取攝像頭設備並填充到下拉菜單
      getCamerasAndPopulateSelect();
    </script>
  </body>
</html>
