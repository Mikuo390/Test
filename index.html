<!DOCTYPE html>
<html>
  <head>
    <title>Quagga JS Example</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.0/quagga.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin: 20px;
      }
      #video {
        border: 1px solid #ccc;
        margin-bottom: 20px;
        position: relative;
      }
      .drawingBuffer {
        position: absolute;
        top: 0;
        left: 0;
      }
    </style>
  </head>

  <body>
    <h1>Quagga 條碼掃描</h1>

    <div style="position: relative;">
      <div id="video" width="100%" height="80%" autoplay></div>
    </div>
    <!-- 顯示掃描結果的區域 -->
    <div style="margin-top: 20px">
      <div id="result">
        條碼結果：<span id="barcode-result"></span>
        <br>
        历史结果: <span id="output"></div>
      </div>
    </div>

  </body>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
  <!-- <script src="./dist/quagga.min.js"></script> -->
  <script type="text/javascript">
    Quagga.init(
      {
        inputStream: {
          name: "Live",
          type: "LiveStream",
          target: document.getElementById("video"),
          // constraints: { width: 640, height: 480, facingMode: "environment" }
        },
        locator: {
            patchSize: "x-small",
            halfSample: false,
            debug: {
              showCanvas: false,
              showPatches: false,
              showFoundPatches: false,
              showSkeleton: false,
              showLabels: false,
              showPatchLabels: false,
              showRemainingPatchLabels: false,
              boxFromPatches: {
                showTransformed: false,
                showTransformedBox: false,
                showBB: false
              }
            }
        },
        // numOfWorkers: 2,
        decoder: {
          readers: [
            // "code_128_reader",
            "ean_reader",
            // "ean_8_reader",
            // "code_39_reader",
            // "code_39_vin_reader",
            // "codabar_reader",
            // "upc_reader",
            // "upc_e_reader",
            // "i2of5_reader",
            // "2of5_reader",
            // "code_93_reader",
          ],
          debug: {
            drawBoundingBox: true,
            showFrequency: true,
            drawScanline: true,
            showPattern: true,
          },
          multiple: false,
        },
      },
      function (err) {
        if (err) {
          console.error(err);
          return;
        }
        console.log("Initialization successful");
        Quagga.start();
        console.log("Initialization start");
      }
    );
    // Quagga.onDetected(function (result) {
    //   console.log(result);
    //   var outputDiv = document.getElementById("output");
    //   outputDiv.innerHTML =
    //     result.codeResult.code + "<br/>" + outputDiv.innerHTML;
    // });

    Quagga.onDetected(function (result) {
      console.log(result);
      console.log(result.codeResult);
      document.getElementById("barcode-result").textContent = result.codeResult.code;
      var outputDiv = document.getElementById("output");
      document.getElementById("output").innerHTML = result.codeResult.code + "<br/>" + outputDiv.innerHTML;
    });

    // 处理识别过程数据，在视频图像上画线/画框
    Quagga.onProcessed(function (result) {
      // console.log(result);
      const drawingCtx = Quagga.canvas.ctx.overlay,
        drawingCanvas = Quagga.canvas.dom.overlay;
      if (result) {
        if (result.boxes) {
          drawingCtx.clearRect(
            0,
            0,
            parseInt(drawingCanvas.getAttribute("width")),
            parseInt(drawingCanvas.getAttribute("height"))
          );
          result.boxes
            .filter(function (box) {
              return box !== result.box;
            })
            .forEach(function (box) {
              Quagga.ImageDebug.drawPath(box, { x: 0, y: 1 }, drawingCtx, {
                color: "green",
                lineWidth: 2,
              });
            });
        }

        if (result.box) {
          Quagga.ImageDebug.drawPath(result.box, { x: 0, y: 1 }, drawingCtx, {
            color: "#00F",
            lineWidth: 2,
          });
        }

        if (result.codeResult && result.codeResult.code) {
          Quagga.ImageDebug.drawPath(
            result.line,
            { x: "x", y: "y" },
            drawingCtx,
            { color: "red", lineWidth: 3 }
          );
        }
      }
    });
  </script>
</html>
